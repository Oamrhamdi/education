<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إديلو - مخطط الدراسة الذكي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #8B5A2B;
            --secondary-color: #A67C52;
            --accent-color: #D2B48C;
            --light-color: #F5F5DC;
            --dark-color: #5D4037;
            --success-color: #8BC34A;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Almarai', 'Tajawal', sans-serif;
            background-color: #F5F5DC;
            background-image: 
                linear-gradient(90deg, rgba(210,180,140,0.1) 1px, transparent 1px),
                linear-gradient(rgba(210,180,140,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            padding: 15px;
            color: var(--dark-color);
            line-height: 1.5;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--accent-color);
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            position: relative;
            padding-bottom: 10px;
            font-family: 'Tajawal', sans-serif;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        h2 {
            color: var(--secondary-color);
            margin: 15px 0 10px;
            font-size: 1.2rem;
            font-family: 'Tajawal', sans-serif;
        }

        .input-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            border: 1px solid rgba(139, 90, 43, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 5px;
            border: 1px solid #D2B48C;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            background-color: rgba(255, 255, 255, 0.8);
            font-family: 'Almarai', sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(139, 90, 43, 0.2);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: auto;
            margin: 5px 0;
            font-family: 'Tajawal', sans-serif;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        button i {
            margin-left: 6px;
            font-size: 12px;
        }

        .btn-secondary {
            background-color: #A67C52;
        }

        .btn-secondary:hover {
            background-color: #8B5A2B;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #7CB342;
        }

        .btn-pdf {
            background-color: #F44336;
        }

        .btn-pdf:hover {
            background-color: #D32F2F;
        }

        .subject-input {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--accent-color);
            transition: var(--transition);
            position: relative;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subject-title {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .remove-subject {
            background-color: var(--danger-color);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
        }

        .remove-subject:hover {
            background-color: #d3166b;
            transform: rotate(90deg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            font-weight: bold;
        }

        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:last-of-type {
            border-bottom: 2px solid var(--primary-color);
        }

        .priority-high {
            color: var(--danger-color);
            font-weight: bold;
        }

        .priority-medium {
            color: var(--warning-color);
            font-weight: bold;
        }

        .priority-low {
            color: #6c757d;
            font-weight: bold;
        }

        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 8px;
            margin: 15px 0;
            height: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 8px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-card {
            background: white;
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .hidden {
            display: none;
        }

        .error {
            color: var(--danger-color);
            background-color: rgba(244, 67, 54, 0.1);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 12px 0;
            border-left: 3px solid var(--danger-color);
            font-size: 13px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .daily-view {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--accent-color);
        }

        .daily-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--accent-color);
        }

        .day-navigation {
            display: flex;
            gap: 10px;
        }

        .day-title {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .daily-lessons {
            margin-top: 10px;
        }

        .daily-lesson {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-color);
        }

        .lesson-priority {
            font-weight: bold;
            margin-left: 5px;
        }

        .lesson-notes {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ddd;
            font-size: 0.9em;
            color: #666;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 3px 10px rgba(139, 90, 43, 0.3);
            cursor: pointer;
            transition: var(--transition);
            z-index: 100;
        }

        .fab:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px) scale(1.05);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .container, .container * {
                visibility: visible;
            }
            .container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                padding: 10px;
            }
            .no-print {
                display: none;
            }
        }

        @media (min-width: 480px) {
            body {
                font-size: 15px;
            }
            
            .container {
                padding: 25px;
                max-width: 95%;
            }
            
            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .actions {
                flex-direction: row;
                justify-content: space-between;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subject-input {
            animation: slideIn 0.3s ease forwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <i class="fas fa-calendar-alt"></i> إديلو - مخطط الدراسة الذكي
        </h1>
        
        <div class="input-section">
            <div class="form-group">
                <label for="numSubjects">عدد المواد الدراسية</label>
                <input type="number" id="numSubjects" min="1" value="5" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="totalDays">المدة الزمنية المتاحة (بالأيام)</label>
                <input type="number" id="totalDays" min="1" value="30" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="studyHours">ساعات الدراسة اليومية</label>
                <input type="number" id="studyHours" min="1" max="24" value="4" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="maxDailyLessons">الحد الأقصى للدروس يومياً (اختياري)</label>
                <input type="number" id="maxDailyLessons" min="1" class="form-control" placeholder="اتركه فارغاً للا محدود">
            </div>
            
            <div class="form-group">
                <label for="maxDailySubjects">الحد الأقصى للمواد يومياً (اختياري)</label>
                <input type="number" id="maxDailySubjects" min="1" class="form-control" placeholder="اتركه فارغاً للا محدود">
            </div>
            
            <div class="actions">
                <button id="generateFormBtn" class="btn-success">
                    <i class="fas fa-magic"></i> إنشاء نموذج المواد
                </button>
            </div>
        </div>
        
        <div id="subjectsForm" class="hidden">
            <h2><i class="fas fa-book-open"></i> تفاصيل المواد الدراسية</h2>
            <div id="subjectsContainer"></div>
            
            <div class="actions">
                <button id="addSubjectBtn" class="btn-secondary">
                    <i class="fas fa-plus"></i> إضافة مادة أخرى
                </button>
                <button id="generateScheduleBtn" class="btn-success">
                    <i class="fas fa-calendar-check"></i> إنشاء جدول الدراسة
                </button>
            </div>
            
            <p id="errorMsg" class="error hidden"></p>
        </div>
        
        <div id="scheduleResult" class="hidden">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">عدد المواد</div>
                    <div class="stat-value" id="statSubjects">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">إجمالي الدروس</div>
                    <div class="stat-value" id="statLessons">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">المدة الزمنية</div>
                    <div class="stat-value" id="statDays">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">الدروس اليومية</div>
                    <div class="stat-value" id="statDailyLessons">0</div>
                </div>
            </div>
            
            <div class="progress-container no-print">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div class="daily-view no-print">
                <div class="daily-view-header">
                    <button id="prevDayBtn" class="btn-secondary">
                        <i class="fas fa-chevron-right"></i> اليوم السابق
                    </button>
                    <div class="day-title" id="currentDayTitle">اليوم 1</div>
                    <button id="nextDayBtn" class="btn-secondary">
                        اليوم التالي <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div id="dailyLessonsContainer"></div>
            </div>
            
            <h2><i class="fas fa-table"></i> جدول الدراسة المقترح</h2>
            <div id="scheduleTable"></div>
            
            <div class="actions no-print">
                <button id="printScheduleBtn" class="btn-secondary">
                    <i class="fas fa-print"></i> طباعة الجدول
                </button>
                <button id="downloadPdfBtn" class="btn-pdf">
                    <i class="fas fa-file-pdf"></i> تنزيل PDF
                </button>
                <button id="newScheduleBtn" class="btn-secondary">
                    <i class="fas fa-redo"></i> إنشاء جدول جديد
                </button>
            </div>
        </div>
    </div>

    <div class="fab no-print" id="helpFab" title="مساعدة">
        <i class="fas fa-question"></i>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // عناصر DOM
            const numSubjectsInput = document.getElementById('numSubjects');
            const totalDaysInput = document.getElementById('totalDays');
            const studyHoursInput = document.getElementById('studyHours');
            const maxDailyLessonsInput = document.getElementById('maxDailyLessons');
            const maxDailySubjectsInput = document.getElementById('maxDailySubjects');
            const generateFormBtn = document.getElementById('generateFormBtn');
            const subjectsForm = document.getElementById('subjectsForm');
            const subjectsContainer = document.getElementById('subjectsContainer');
            const addSubjectBtn = document.getElementById('addSubjectBtn');
            const generateScheduleBtn = document.getElementById('generateScheduleBtn');
            const scheduleResult = document.getElementById('scheduleResult');
            const scheduleTable = document.getElementById('scheduleTable');
            const errorMsg = document.getElementById('errorMsg');
            const printScheduleBtn = document.getElementById('printScheduleBtn');
            const newScheduleBtn = document.getElementById('newScheduleBtn');
            const helpFab = document.getElementById('helpFab');
            const prevDayBtn = document.getElementById('prevDayBtn');
            const nextDayBtn = document.getElementById('nextDayBtn');
            const currentDayTitle = document.getElementById('currentDayTitle');
            const dailyLessonsContainer = document.getElementById('dailyLessonsContainer');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            
            // إحصائيات
            const statSubjects = document.getElementById('statSubjects');
            const statLessons = document.getElementById('statLessons');
            const statDays = document.getElementById('statDays');
            const statDailyLessons = document.getElementById('statDailyLessons');
            const progressBar = document.getElementById('progressBar');
            
            let subjectCounter = 0;
            const averageStudyHours = 4;
            let currentSchedule = [];
            let currentDayIndex = 0;

            // إنشاء حقول إدخال لكل مادة
            function generateSubjectInputs(count) {
                subjectsContainer.innerHTML = '';
                subjectCounter = 0;
                
                for (let i = 0; i < count; i++) {
                    addSubjectInput();
                }
            }
            
            // إضافة حقل إدخال لمادة واحدة
            function addSubjectInput() {
                const subjectDiv = document.createElement('div');
                subjectDiv.className = 'subject-input';
                subjectDiv.id = `subject-${subjectCounter}`;
                
                subjectDiv.innerHTML = `
                    <div class="subject-header">
                        <div class="subject-title">المادة ${subjectCounter + 1}</div>
                        <button class="remove-subject" data-id="${subjectCounter}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="subjectName${subjectCounter}">اسم المادة:</label>
                        <input type="text" id="subjectName${subjectCounter}" required placeholder="أدخل اسم المادة">
                    </div>
                    
                    <div class="form-group">
                        <label for="subjectLessons${subjectCounter}">عدد الدروس:</label>
                        <input type="number" id="subjectLessons${subjectCounter}" min="1" value="10" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="subjectDifficulty${subjectCounter}">صعوبة المادة:</label>
                        <select id="subjectDifficulty${subjectCounter}">
                            <option value="3">صعبة</option>
                            <option value="2" selected>متوسطة</option>
                            <option value="1">سهلة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subjectPriority${subjectCounter}">أولوية المادة:</label>
                        <select id="subjectPriority${subjectCounter}">
                            <option value="3">عالية</option>
                            <option value="2" selected>متوسطة</option>
                            <option value="1">منخفضة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subjectNotes${subjectCounter}">ملاحظات:</label>
                        <textarea id="subjectNotes${subjectCounter}" rows="2" placeholder="أي ملاحظات إضافية عن المادة"></textarea>
                    </div>
                `;
                
                subjectsContainer.appendChild(subjectDiv);
                subjectCounter++;
            }
            
            // إنشاء نموذج المواد
            generateFormBtn.addEventListener('click', function() {
                const numSubjects = parseInt(numSubjectsInput.value);
                const totalDays = parseInt(totalDaysInput.value);
                const studyHours = parseInt(studyHoursInput.value);
                
                if (numSubjects < 1 || isNaN(numSubjects)) {
                    showError("الرجاء إدخال عدد مواد صحيح أكبر من الصفر");
                    return;
                }
                
                if (totalDays < 1 || isNaN(totalDays)) {
                    showError("الرجاء إدخال عدد أيام صحيح أكبر من الصفر");
                    return;
                }
                
                if (studyHours < 1 || studyHours > 24 || isNaN(studyHours)) {
                    showError("الرجاء إدخال عدد ساعات دراسة صحيح بين 1 و 24");
                    return;
                }
                
                generateSubjectInputs(numSubjects);
                subjectsForm.classList.remove('hidden');
                scheduleResult.classList.add('hidden');
                hideError();
                
                subjectsForm.scrollIntoView({ behavior: 'smooth' });
            });
            
            // إضافة مادة جديدة
            addSubjectBtn.addEventListener('click', function() {
                addSubjectInput();
                document.getElementById(`subject-${subjectCounter - 1}`).scrollIntoView({ behavior: 'smooth' });
            });
            
            // إزالة مادة
            subjectsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-subject') || e.target.closest('.remove-subject')) {
                    const subjectId = e.target.closest('.remove-subject').getAttribute('data-id');
                    const subjectElement = document.getElementById(`subject-${subjectId}`);
                    
                    subjectElement.style.transform = 'translateX(100%)';
                    subjectElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        subjectElement.remove();
                        const subjects = subjectsContainer.querySelectorAll('.subject-input');
                        subjects.forEach((subject, index) => {
                            subject.querySelector('.subject-title').textContent = `المادة ${index + 1}`;
                        });
                    }, 300);
                }
            });
            
            // إنشاء جدول الدراسة
            generateScheduleBtn.addEventListener('click', function() {
                const totalDays = parseInt(totalDaysInput.value);
                const studyHours = parseInt(studyHoursInput.value);
                const maxDailyLessons = maxDailyLessonsInput.value ? parseInt(maxDailyLessonsInput.value) : null;
                const maxDailySubjects = maxDailySubjectsInput.value ? parseInt(maxDailySubjectsInput.value) : null;
                const subjects = [];
                let totalLessons = 0;
                
                const subjectElements = subjectsContainer.querySelectorAll('.subject-input');
                if (subjectElements.length === 0) {
                    showError("الرجاء إضافة مادة واحدة على الأقل");
                    return;
                }
                
                subjectElements.forEach((element, index) => {
                    const name = document.getElementById(`subjectName${index}`).value.trim();
                    const lessons = parseInt(document.getElementById(`subjectLessons${index}`).value);
                    const difficulty = parseInt(document.getElementById(`subjectDifficulty${index}`).value);
                    const priority = parseInt(document.getElementById(`subjectPriority${index}`).value);
                    const notes = document.getElementById(`subjectNotes${index}`).value.trim();
                    
                    if (!name || isNaN(lessons) || lessons < 1) {
                        showError(`الرجاء إدخال بيانات صحيحة للمادة ${index + 1}`);
                        return;
                    }
                    
                    subjects.push({
                        id: index,
                        name: name,
                        lessons: lessons,
                        difficulty: difficulty,
                        priority: priority,
                        notes: notes
                    });
                    
                    totalLessons += lessons;
                });
                
                if (totalLessons === 0) {
                    showError("إجمالي الدروس يجب أن يكون أكبر من الصفر");
                    return;
                }
                
                const baseLessonsPerDay = Math.ceil(totalLessons / totalDays);
                const adjustedLessonsPerDay = Math.ceil(baseLessonsPerDay * (studyHours / averageStudyHours));
                
                const schedule = createSchedule(subjects, totalDays, adjustedLessonsPerDay, maxDailyLessons, maxDailySubjects);
                
                displayStats(subjects, totalDays, adjustedLessonsPerDay);
                displaySchedule(schedule);
                scheduleResult.classList.remove('hidden');
                hideError();
                
                scheduleResult.scrollIntoView({ behavior: 'smooth' });
            });
            
            // إنشاء جدول الدراسة
            function createSchedule(subjects, totalDays, lessonsPerDay, maxDailyLessons, maxDailySubjects) {
                const subjectsCopy = JSON.parse(JSON.stringify(subjects));
                
                subjectsCopy.forEach(subject => {
                    subject.weight = subject.priority * 0.7 + subject.difficulty * 0.3;
                });
                
                subjectsCopy.sort((a, b) => b.weight - a.weight);
                
                const schedule = [];
                let currentDay = 1;
                
                while (currentDay <= totalDays && subjectsCopy.some(sub => sub.lessons > 0)) {
                    const dailyLessons = [];
                    let remainingLessons = maxDailyLessons ? Math.min(lessonsPerDay, maxDailyLessons) : lessonsPerDay;
                    let remainingSubjects = maxDailySubjects || Infinity;
                    
                    // توزيع الدروس حسب الوزن مع مراعاة الحدود الجديدة
                    for (let i = 0; i < subjectsCopy.length && remainingLessons > 0 && remainingSubjects > 0; i++) {
                        if (subjectsCopy[i].lessons > 0) {
                            const activeSubjects = subjectsCopy.filter(sub => sub.lessons > 0);
                            const totalWeight = activeSubjects.reduce((sum, sub) => sum + sub.weight, 0);
                            const weightPercentage = subjectsCopy[i].weight / totalWeight;
                            
                            let suggestedLessons = Math.max(1, Math.floor(lessonsPerDay * weightPercentage));
                            let taken = Math.min(subjectsCopy[i].lessons, suggestedLessons, remainingLessons);
                            
                            // التأكد من عدم تجاوز الحد الأقصى للمواد
                            if (dailyLessons.length >= remainingSubjects) {
                                taken = 0;
                            }
                            
                            if (taken > 0) {
                                const existingSubject = dailyLessons.find(item => item.subjectId === subjectsCopy[i].id);
                                if (existingSubject) {
                                    existingSubject.lessons += taken;
                                } else {
                                    dailyLessons.push({
                                        subjectId: subjectsCopy[i].id,
                                        subjectName: subjectsCopy[i].name,
                                        lessons: taken,
                                        priority: subjectsCopy[i].priority,
                                        notes: subjectsCopy[i].notes
                                    });
                                    remainingSubjects--;
                                }
                                
                                subjectsCopy[i].lessons -= taken;
                                remainingLessons -= taken;
                            }
                        }
                    }
                    
                    // إذا بقي دروس ولم يتم توزيعها بسبب الوزن، نوزعها بالتساوي
                    if (remainingLessons > 0 && remainingSubjects > 0) {
                        const remainingSubjectsList = subjectsCopy.filter(sub => sub.lessons > 0);
                        
                        if (remainingSubjectsList.length > 0) {
                            const perSubject = Math.max(1, Math.floor(remainingLessons / remainingSubjectsList.length));
                            
                            for (let i = 0; i < remainingSubjectsList.length && remainingLessons > 0 && remainingSubjects > 0; i++) {
                                const taken = Math.min(remainingSubjectsList[i].lessons, perSubject, remainingLessons);
                                
                                if (taken > 0) {
                                    const existingSubject = dailyLessons.find(item => item.subjectId === remainingSubjectsList[i].id);
                                    if (existingSubject) {
                                        existingSubject.lessons += taken;
                                    } else {
                                        dailyLessons.push({
                                            subjectId: remainingSubjectsList[i].id,
                                            subjectName: remainingSubjectsList[i].name,
                                            lessons: taken,
                                            priority: remainingSubjectsList[i].priority,
                                            notes: remainingSubjectsList[i].notes
                                        });
                                        remainingSubjects--;
                                    }
                                    
                                    remainingSubjectsList[i].lessons -= taken;
                                    remainingLessons -= taken;
                                }
                            }
                        }
                    }
                    
                    // إذا بقي دروس بعد التوزيع بالتساوي
                    if (remainingLessons > 0 && remainingSubjects > 0) {
                        for (let i = 0; i < subjectsCopy.length && remainingLessons > 0 && remainingSubjects > 0; i++) {
                            if (subjectsCopy[i].lessons > 0) {
                                const taken = Math.min(subjectsCopy[i].lessons, remainingLessons);
                                
                                const existingSubject = dailyLessons.find(item => item.subjectId === subjectsCopy[i].id);
                                if (existingSubject) {
                                    existingSubject.lessons += taken;
                                } else {
                                    dailyLessons.push({
                                        subjectId: subjectsCopy[i].id,
                                        subjectName: subjectsCopy[i].name,
                                        lessons: taken,
                                        priority: subjectsCopy[i].priority,
                                        notes: subjectsCopy[i].notes
                                    });
                                    remainingSubjects--;
                                }
                                
                                subjectsCopy[i].lessons -= taken;
                                remainingLessons -= taken;
                            }
                        }
                    }
                    
                    schedule.push({
                        day: currentDay,
                        lessons: dailyLessons,
                        totalLessons: dailyLessons.reduce((sum, lesson) => sum + lesson.lessons, 0),
                        totalSubjects: dailyLessons.length
                    });
                    
                    currentDay++;
                }
                
                return schedule;
            }
            
            // عرض الإحصائيات
            function displayStats(subjects, totalDays, lessonsPerDay) {
                const totalLessons = subjects.reduce((sum, subject) => sum + subject.lessons, 0);
                
                statSubjects.textContent = subjects.length;
                statLessons.textContent = totalLessons;
                statDays.textContent = totalDays;
                statDailyLessons.textContent = lessonsPerDay;
                
                const totalPossibleLessons = lessonsPerDay * totalDays;
                const progressPercentage = Math.min(100, Math.round((totalLessons / totalPossibleLessons) * 100));
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.textContent = `${progressPercentage}%`;
            }
            
            // عرض جدول الدراسة
            function displaySchedule(schedule) {
                currentSchedule = schedule;
                currentDayIndex = 0;
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>اليوم</th>
                                <th>المواد والدروس</th>
                                <th>إجمالي الدروس</th>
                                <th>عدد المواد</th>
                                <th class="no-print">ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const day of schedule) {
                    let lessonsList = '';
                    let notesList = '';
                    
                    day.lessons.sort((a, b) => b.priority - a.priority);
                    
                    for (const lesson of day.lessons) {
                        const priorityClass = getPriorityClass(lesson.priority);
                        lessonsList += `
                            <div>
                                <span class="${priorityClass}">${lesson.subjectName}</span>
                                (${lesson.lessons} درس)
                            </div>
                        `;
                        
                        if (lesson.notes) {
                            notesList += `
                                <div>
                                    <strong>${lesson.subjectName}:</strong> ${lesson.notes}
                                </div>
                            `;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${day.day}</td>
                            <td>${lessonsList || 'لا توجد دروس'}</td>
                            <td>${day.totalLessons}</td>
                            <td>${day.totalSubjects}</td>
                            <td class="no-print">${notesList || 'لا توجد ملاحظات'}</td>
                        </tr>
                    `;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
                
                scheduleTable.innerHTML = html;
                
                showDay(0);
            }
            
            // عرض يوم معين
            function showDay(dayIndex) {
                if (currentSchedule.length === 0 || dayIndex < 0 || dayIndex >= currentSchedule.length) return;
                
                const day = currentSchedule[dayIndex];
                currentDayIndex = dayIndex;
                
                currentDayTitle.textContent = `اليوم ${day.day}`;
                
                prevDayBtn.disabled = dayIndex === 0;
                nextDayBtn.disabled = dayIndex === currentSchedule.length - 1;
                
                let html = '';
                
                if (day.lessons.length === 0) {
                    html = '<div class="daily-lesson">لا توجد دروس لهذا اليوم</div>';
                } else {
                    day.lessons.sort((a, b) => b.priority - a.priority);
                    
                    for (const lesson of day.lessons) {
                        const priorityClass = getPriorityClass(lesson.priority);
                        const priorityText = getPriorityText(lesson.priority);
                        
                        html += `
                            <div class="daily-lesson">
                                <div>
                                    <strong>${lesson.subjectName}</strong>
                                    <span class="lesson-priority ${priorityClass}">(${priorityText})</span>
                                    <span> - ${lesson.lessons} درس</span>
                                </div>
                                ${lesson.notes ? `<div class="lesson-notes">${lesson.notes}</div>` : ''}
                            </div>
                        `;
                    }
                }
                
                dailyLessonsContainer.innerHTML = html;
            }
            
            // الحصول على كلاس الأولوية
            function getPriorityClass(priority) {
                switch(priority) {
                    case 3: return 'priority-high';
                    case 2: return 'priority-medium';
                    case 1: return 'priority-low';
                    default: return '';
                }
            }
            
            // الحصول على نص الأولوية
            function getPriorityText(priority) {
                switch(priority) {
                    case 3: return 'أولوية عالية';
                    case 2: return 'أولوية متوسطة';
                    case 1: return 'أولوية منخفضة';
                    default: return '';
                }
            }
            
            // التنقل بين الأيام
            prevDayBtn.addEventListener('click', function() {
                if (currentDayIndex > 0) {
                    showDay(currentDayIndex - 1);
                }
            });
            
            nextDayBtn.addEventListener('click', function() {
                if (currentDayIndex < currentSchedule.length - 1) {
                    showDay(currentDayIndex + 1);
                }
            });
            
            // طباعة الجدول
            printScheduleBtn.addEventListener('click', function() {
                window.print();
            });
            
            // تنزيل الجدول كـ PDF
            downloadPdfBtn.addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('جدول الدراسة - إديلو', 40, 40);
                
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(12);
                const today = new Date();
                doc.text(`تاريخ الإنشاء: ${today.toLocaleDateString('ar-EG')}`, 40, 60);
                
                doc.setFontSize(14);
                doc.text(`عدد المواد: ${statSubjects.textContent}`, 40, 90);
                doc.text(`إجمالي الدروس: ${statLessons.textContent}`, 40, 110);
                doc.text(`المدة الزمنية: ${statDays.textContent} يوم`, 40, 130);
                doc.text(`الدروس اليومية: ${statDailyLessons.textContent}`, 40, 150);
                
                let y = 180;
                doc.setFontSize(12);
                doc.setFont('Helvetica', 'bold');
                doc.text('اليوم', 40, y);
                doc.text('المواد والدروس', 100, y);
                doc.text('عدد الدروس', 400, y);
                doc.text('عدد المواد', 450, y);
                y += 20;
                
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(10);
                
                for (const day of currentSchedule) {
                    doc.setFillColor(210, 180, 140);
                    doc.rect(40, y-10, 500, 15, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('Helvetica', 'bold');
                    doc.text(`اليوم ${day.day}`, 45, y);
                    y += 20;
                    
                    doc.setFont('Helvetica', 'normal');
                    for (const lesson of day.lessons) {
                        const priorityColor = getPriorityColor(lesson.priority);
                        
                        doc.setTextColor(priorityColor.r, priorityColor.g, priorityColor.b);
                        doc.text(lesson.subjectName, 100, y);
                        doc.text(lesson.lessons.toString(), 400, y);
                        doc.text(day.totalSubjects.toString(), 450, y);
                        
                        if (lesson.notes) {
                            doc.setTextColor(100, 100, 100);
                            doc.setFontSize(8);
                            doc.text(`ملاحظات: ${lesson.notes}`, 100, y + 15);
                            doc.setFontSize(10);
                            y += 15;
                        }
                        
                        y += 20;
                        
                        if (y > 700) {
                            doc.addPage();
                            y = 40;
                        }
                    }
                    
                    doc.setTextColor(0, 0, 0);
                    y += 10;
                }
                
                doc.save('جدول_الدراسة_إديلو.pdf');
            });
            
            // الحصول على لون الأولوية لـ PDF
            function getPriorityColor(priority) {
                switch(priority) {
                    case 3: return {r: 244, g: 67, b: 54};
                    case 2: return {r: 255, g: 193, b: 7};
                    case 1: return {r: 108, g: 117, b: 125};
                    default: return {r: 0, g: 0, b: 0};
                }
            }
            
            // إنشاء جدول جديد
            newScheduleBtn.addEventListener('click', function() {
                scheduleResult.classList.add('hidden');
                subjectsForm.classList.remove('hidden');
                subjectsContainer.scrollIntoView({ behavior: 'smooth' });
            });
            
            // زر المساعدة
            helpFab.addEventListener('click', function() {
                alert(`إديلو - مساعدة\n\n1. أدخل عدد المواد والمدة الزمنية وساعات الدراسة اليومية\n2. اضغط على "إنشاء نموذج المواد"\n3. املأ تفاصيل كل مادة (الاسم، عدد الدروس، الصعوبة، الأولوية)\n4. اضغط على "إنشاء جدول الدراسة" للحصول على جدولك الدراسي\n\nيمكنك إضافة أو إزالة مواد حسب الحاجة`);
            });
            
            // عرض خطأ
            function showError(message) {
                errorMsg.textContent = message;
                errorMsg.classList.remove('hidden');
                errorMsg.scrollIntoView({ behavior: 'smooth' });
                
                setTimeout(hideError, 5000);
            }
            
            function hideError() {
                errorMsg.textContent = '';
                errorMsg.classList.add('hidden');
            }
        });
    </script>
</body>
</html>